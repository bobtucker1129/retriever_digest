# Ralph Progress Log
Started: Tue Jan 20 23:22:04 EST 2026

## Codebase Patterns
- Next.js 14 App Router with TypeScript in `src/app` directory
- Run `npx tsc --noEmit` to typecheck
- Prisma 7 uses `prisma.config.ts` for DATABASE_URL (not in schema.prisma)
- Prisma client generated to `src/generated/prisma`
- Manually create migration files when DB unavailable: `prisma/migrations/<timestamp>_<name>/migration.sql`
- Use `IF NOT EXISTS` in migration SQL for idempotency
- Prisma 7 requires driver adapter: `new PrismaClient({ adapter: new PrismaPg({ connectionString }) })`
- Import PrismaClient from `src/generated/prisma/client` (not the folder directly)
- Use route groups `(admin)` and `(auth)` to separate layouts - admin has header/nav, auth is minimal
- Session cookie name: `retriever_session`, expires 7 days
- Use `export const dynamic = 'force-dynamic'` for pages with DB queries to avoid SSG build errors
- Install @prisma/client in addition to prisma dev dependency for runtime

---

## 2026-01-20 - US-001
Thread: https://ampcode.com/threads/T-019bdec9-e13c-74a8-9e57-bf55a5064abe
- Initialized Next.js 14 project with TypeScript and App Router
- Created src/app/layout.tsx and src/app/page.tsx
- Added .env.example with placeholders for all required env vars
- Added .gitignore for node_modules, .env, .next
- Verified `npm run dev` works and typecheck passes
- **Learnings for future iterations:**
  - Create-next-app fails when directory has existing files; manually set up instead
  - Next.js 14 with App Router uses `src/app` directory structure

---

## 2026-01-21 - US-002
Thread: https://ampcode.com/threads/T-019bdecb-9c0b-76cf-94a0-8a968d67b816
- Set up Prisma with PostgreSQL connection
- Installed prisma (dev) and dotenv packages
- Created prisma/schema.prisma with PostgreSQL provider
- Created prisma.config.ts with DATABASE_URL configuration
- Prisma client generated to src/generated/prisma
- **Learnings for future iterations:**
  - Prisma 7 no longer uses `url = env("DATABASE_URL")` in schema.prisma
  - Connection URL is now configured in prisma.config.ts
  - Must install dotenv for prisma.config.ts to read env vars

---

## 2026-01-21 - US-003
Thread: https://ampcode.com/threads/T-019bdecc-e470-75d8-bf72-0749e9bed927
- Created Goal model with enum GoalType (MONTHLY, ANNUAL)
- Added fields: id, type (unique), salesRevenue (Decimal 12,2), salesCount, estimatesCreated, newCustomers, createdAt, updatedAt
- Created migration file in prisma/migrations/20260121000000_add_goal_model/
- Regenerated Prisma client with Goal model types
- **Learnings for future iterations:**
  - Prisma migrations require DB connection; use `--create-only` or manually create migration files when DB is unavailable
  - Use @unique on type field to enforce one record per GoalType (upsert pattern)
  - Use `CREATE TABLE IF NOT EXISTS` and `CREATE TYPE` for idempotent migrations

---

## 2026-01-21 - US-004
Thread: https://ampcode.com/threads/T-019bdece-2f4a-742e-b442-122adee1ceb5
- Created Recipient model with fields: id, name, email (unique), active (default true), createdAt, updatedAt
- Created migration file in prisma/migrations/20260121000001_add_recipient_model/
- Regenerated Prisma client with Recipient model types
- **Learnings for future iterations:**
  - Follow same pattern as Goal migration: use `IF NOT EXISTS` for tables and indexes

---

## 2026-01-21 - US-005
Thread: https://ampcode.com/threads/T-019bdecf-329f-777e-8669-814c097a9078
- Created DigestData model with fields: id, exportDate (DateTime unique), data (Json), createdAt
- Created migration file in prisma/migrations/20260121000002_add_digest_data_model/
- Used JSONB type for PostgreSQL JSON data storage
- Regenerated Prisma client with DigestData model types
- **Learnings for future iterations:**
  - Use JSONB (not JSON) in PostgreSQL for better indexing/querying support

---

## 2026-01-21 - US-006
Thread: https://ampcode.com/threads/T-019bded0-3396-704f-a87c-aa26e7087b94
- Created prisma/seed.ts with sample data for Goals, Recipients, and DigestData
- Added `prisma:seed` script and prisma config to package.json
- Installed tsx (TypeScript executor) and @prisma/adapter-pg with pg driver
- **Learnings for future iterations:**
  - Prisma 7 requires driver adapters for all database connections
  - Use `@prisma/adapter-pg` with `PrismaPg({ connectionString })` for PostgreSQL
  - Import PrismaClient from `client.ts` file in generated folder, not from the folder directly
  - Seeds must use dotenv/config import at top for environment variables

---

## 2026-01-21 - US-007
Thread: https://ampcode.com/threads/T-019bded2-f46e-751b-aac2-3714e4c0a8c2
- Created admin layout with header, Retriever logo (inline SVG), and navigation tabs
- Added globals.css with responsive styling and CSS variables
- Created Navigation component with active tab highlighting using usePathname
- Created placeholder pages for /goals, /recipients, /testing routes
- Root page redirects to /goals
- Verified all pages work via dev server on localhost:3000
- **Learnings for future iterations:**
  - Use `'use client'` directive for components using Next.js hooks like usePathname
  - Inline SVG logos avoid external asset dependencies and bundle well
  - CSS variables in :root scope for consistent theming across components

---

## 2026-01-21 - US-008
Thread: https://ampcode.com/threads/T-019bded4-ab92-72c6-85b1-49574f458e69
- Added password protection middleware using Next.js middleware.ts
- Created /login page with password input and styled form
- Created /api/auth/login API endpoint that validates password and sets session cookie
- Restructured routes using route groups: (admin) for protected pages, (auth) for login
- Session cookie expires after 7 days, uses httpOnly and secure flags in production
- Public paths: /login, /api/auth/login, /api/export (no auth required)
- **Learnings for future iterations:**
  - Route groups (parentheses) allow different layouts without affecting URL structure
  - middleware.ts at src/ level intercepts all routes for auth checks
  - Clear .next cache with `rm -rf .next` when restructuring routes

---

## 2026-01-21 - US-009
Thread: https://ampcode.com/threads/T-019bded8-b1c3-7663-8ed9-609bd0f3536b
- Created Goals page with Monthly and Annual goal forms
- Added GoalForm component with labeled input fields for all 4 metrics
- Created server action getGoals() to fetch existing goals from database
- Created centralized Prisma client utility in src/lib/db.ts
- Added responsive CSS styling for goals grid layout
- Fixed Prisma build error by installing @prisma/client runtime package
- **Learnings for future iterations:**
  - Prisma 7 needs both `prisma` (dev) and `@prisma/client` (runtime) packages
  - Pages that fetch from database at render time need `export const dynamic = 'force-dynamic'`
  - Export types from actions.ts for use in UI components

---

## 2026-01-21 - US-010
Thread: https://ampcode.com/threads/T-019bdeda-f485-713b-8ea3-bad6507eb80a
- Added saveGoal server action with upsert logic for goals
- Updated GoalForm with Save button, loading state, and success/error messages
- Added CSS styles for save button and goal messages with responsive layout
- Using defaultValue ensures form retains values after save (no flash/reset)
- **Learnings for future iterations:**
  - Prisma Decimal fields accept string values directly, no need to import Decimal class
  - Use handleSubmit with formRef pattern for client-side form handling with server actions
  - Success/error messages with setTimeout auto-clear provide good UX feedback

---

## 2026-01-21 - US-011
Thread: https://ampcode.com/threads/T-019bdedd-40ef-75f9-952a-90bc80181277
- Created Recipients page with table showing Name, Email, Status, Actions columns
- Added getRecipients server action with alphabetical sorting by name
- Created RecipientsTable client component with empty state message
- Status badge shows "Active" (green) or "Inactive" (gray) styling
- Added responsive CSS styles for table with horizontal scroll on mobile
- **Learnings for future iterations:**
  - Follow existing pattern: page.tsx fetches data, passes to client component for display
  - Use CSS pill/badge styling for status indicators with color coding

---

## 2026-01-21 - US-012
Thread: https://ampcode.com/threads/T-019bdede-fbee-720d-9763-002024a7c0c1
- Added "Add Recipient" button above the recipients table
- Created modal with Name and Email input fields
- Added client-side and server-side email format validation
- Added addRecipient server action that creates recipient with active: true
- Table updates immediately without page reload (using local state)
- Success message "Recipient added" shown with auto-clear after 3 seconds
- **Learnings for future iterations:**
  - Changed RecipientsTable prop from `recipients` to `initialRecipients` to manage state locally
  - Use modal-overlay with stopPropagation to allow clicking outside to close modal
  - Keep new recipients sorted alphabetically when adding to local state

---
