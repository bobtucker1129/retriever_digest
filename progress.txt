# Ralph Progress Log
Started: Tue Jan 20 23:22:04 EST 2026

## Codebase Patterns
- Next.js 14 App Router with TypeScript in `src/app` directory
- Run `npx tsc --noEmit` to typecheck
- Prisma 7 uses `prisma.config.ts` for DATABASE_URL (not in schema.prisma)
- Prisma client generated to `src/generated/prisma`
- Manually create migration files when DB unavailable: `prisma/migrations/<timestamp>_<name>/migration.sql`
- Use `IF NOT EXISTS` in migration SQL for idempotency
- Prisma 7 requires driver adapter: `new PrismaClient({ adapter: new PrismaPg({ connectionString }) })`
- Import PrismaClient from `src/generated/prisma/client` (not the folder directly)
- Use route groups `(admin)` and `(auth)` to separate layouts - admin has header/nav, auth is minimal
- Session cookie name: `retriever_session`, expires 7 days
- Use `export const dynamic = 'force-dynamic'` for pages with DB queries to avoid SSG build errors
- Install @prisma/client in addition to prisma dev dependency for runtime

---

## 2026-01-20 - US-001
Thread: https://ampcode.com/threads/T-019bdec9-e13c-74a8-9e57-bf55a5064abe
- Initialized Next.js 14 project with TypeScript and App Router
- Created src/app/layout.tsx and src/app/page.tsx
- Added .env.example with placeholders for all required env vars
- Added .gitignore for node_modules, .env, .next
- Verified `npm run dev` works and typecheck passes
- **Learnings for future iterations:**
  - Create-next-app fails when directory has existing files; manually set up instead
  - Next.js 14 with App Router uses `src/app` directory structure

---

## 2026-01-21 - US-002
Thread: https://ampcode.com/threads/T-019bdecb-9c0b-76cf-94a0-8a968d67b816
- Set up Prisma with PostgreSQL connection
- Installed prisma (dev) and dotenv packages
- Created prisma/schema.prisma with PostgreSQL provider
- Created prisma.config.ts with DATABASE_URL configuration
- Prisma client generated to src/generated/prisma
- **Learnings for future iterations:**
  - Prisma 7 no longer uses `url = env("DATABASE_URL")` in schema.prisma
  - Connection URL is now configured in prisma.config.ts
  - Must install dotenv for prisma.config.ts to read env vars

---

## 2026-01-21 - US-003
Thread: https://ampcode.com/threads/T-019bdecc-e470-75d8-bf72-0749e9bed927
- Created Goal model with enum GoalType (MONTHLY, ANNUAL)
- Added fields: id, type (unique), salesRevenue (Decimal 12,2), salesCount, estimatesCreated, newCustomers, createdAt, updatedAt
- Created migration file in prisma/migrations/20260121000000_add_goal_model/
- Regenerated Prisma client with Goal model types
- **Learnings for future iterations:**
  - Prisma migrations require DB connection; use `--create-only` or manually create migration files when DB is unavailable
  - Use @unique on type field to enforce one record per GoalType (upsert pattern)
  - Use `CREATE TABLE IF NOT EXISTS` and `CREATE TYPE` for idempotent migrations

---

## 2026-01-21 - US-004
Thread: https://ampcode.com/threads/T-019bdece-2f4a-742e-b442-122adee1ceb5
- Created Recipient model with fields: id, name, email (unique), active (default true), createdAt, updatedAt
- Created migration file in prisma/migrations/20260121000001_add_recipient_model/
- Regenerated Prisma client with Recipient model types
- **Learnings for future iterations:**
  - Follow same pattern as Goal migration: use `IF NOT EXISTS` for tables and indexes

---

## 2026-01-21 - US-005
Thread: https://ampcode.com/threads/T-019bdecf-329f-777e-8669-814c097a9078
- Created DigestData model with fields: id, exportDate (DateTime unique), data (Json), createdAt
- Created migration file in prisma/migrations/20260121000002_add_digest_data_model/
- Used JSONB type for PostgreSQL JSON data storage
- Regenerated Prisma client with DigestData model types
- **Learnings for future iterations:**
  - Use JSONB (not JSON) in PostgreSQL for better indexing/querying support

---

## 2026-01-21 - US-006
Thread: https://ampcode.com/threads/T-019bded0-3396-704f-a87c-aa26e7087b94
- Created prisma/seed.ts with sample data for Goals, Recipients, and DigestData
- Added `prisma:seed` script and prisma config to package.json
- Installed tsx (TypeScript executor) and @prisma/adapter-pg with pg driver
- **Learnings for future iterations:**
  - Prisma 7 requires driver adapters for all database connections
  - Use `@prisma/adapter-pg` with `PrismaPg({ connectionString })` for PostgreSQL
  - Import PrismaClient from `client.ts` file in generated folder, not from the folder directly
  - Seeds must use dotenv/config import at top for environment variables

---

## 2026-01-21 - US-007
Thread: https://ampcode.com/threads/T-019bded2-f46e-751b-aac2-3714e4c0a8c2
- Created admin layout with header, Retriever logo (inline SVG), and navigation tabs
- Added globals.css with responsive styling and CSS variables
- Created Navigation component with active tab highlighting using usePathname
- Created placeholder pages for /goals, /recipients, /testing routes
- Root page redirects to /goals
- Verified all pages work via dev server on localhost:3000
- **Learnings for future iterations:**
  - Use `'use client'` directive for components using Next.js hooks like usePathname
  - Inline SVG logos avoid external asset dependencies and bundle well
  - CSS variables in :root scope for consistent theming across components

---

## 2026-01-21 - US-008
Thread: https://ampcode.com/threads/T-019bded4-ab92-72c6-85b1-49574f458e69
- Added password protection middleware using Next.js middleware.ts
- Created /login page with password input and styled form
- Created /api/auth/login API endpoint that validates password and sets session cookie
- Restructured routes using route groups: (admin) for protected pages, (auth) for login
- Session cookie expires after 7 days, uses httpOnly and secure flags in production
- Public paths: /login, /api/auth/login, /api/export (no auth required)
- **Learnings for future iterations:**
  - Route groups (parentheses) allow different layouts without affecting URL structure
  - middleware.ts at src/ level intercepts all routes for auth checks
  - Clear .next cache with `rm -rf .next` when restructuring routes

---

## 2026-01-21 - US-009
Thread: https://ampcode.com/threads/T-019bded8-b1c3-7663-8ed9-609bd0f3536b
- Created Goals page with Monthly and Annual goal forms
- Added GoalForm component with labeled input fields for all 4 metrics
- Created server action getGoals() to fetch existing goals from database
- Created centralized Prisma client utility in src/lib/db.ts
- Added responsive CSS styling for goals grid layout
- Fixed Prisma build error by installing @prisma/client runtime package
- **Learnings for future iterations:**
  - Prisma 7 needs both `prisma` (dev) and `@prisma/client` (runtime) packages
  - Pages that fetch from database at render time need `export const dynamic = 'force-dynamic'`
  - Export types from actions.ts for use in UI components

---

## 2026-01-21 - US-010
Thread: https://ampcode.com/threads/T-019bdeda-f485-713b-8ea3-bad6507eb80a
- Added saveGoal server action with upsert logic for goals
- Updated GoalForm with Save button, loading state, and success/error messages
- Added CSS styles for save button and goal messages with responsive layout
- Using defaultValue ensures form retains values after save (no flash/reset)
- **Learnings for future iterations:**
  - Prisma Decimal fields accept string values directly, no need to import Decimal class
  - Use handleSubmit with formRef pattern for client-side form handling with server actions
  - Success/error messages with setTimeout auto-clear provide good UX feedback

---

## 2026-01-21 - US-011
Thread: https://ampcode.com/threads/T-019bdedd-40ef-75f9-952a-90bc80181277
- Created Recipients page with table showing Name, Email, Status, Actions columns
- Added getRecipients server action with alphabetical sorting by name
- Created RecipientsTable client component with empty state message
- Status badge shows "Active" (green) or "Inactive" (gray) styling
- Added responsive CSS styles for table with horizontal scroll on mobile
- **Learnings for future iterations:**
  - Follow existing pattern: page.tsx fetches data, passes to client component for display
  - Use CSS pill/badge styling for status indicators with color coding

---

## 2026-01-21 - US-012
Thread: https://ampcode.com/threads/T-019bdede-fbee-720d-9763-002024a7c0c1
- Added "Add Recipient" button above the recipients table
- Created modal with Name and Email input fields
- Added client-side and server-side email format validation
- Added addRecipient server action that creates recipient with active: true
- Table updates immediately without page reload (using local state)
- Success message "Recipient added" shown with auto-clear after 3 seconds
- **Learnings for future iterations:**
  - Changed RecipientsTable prop from `recipients` to `initialRecipients` to manage state locally
  - Use modal-overlay with stopPropagation to allow clicking outside to close modal
  - Keep new recipients sorted alphabetically when adding to local state

---

## 2026-01-20 - US-013
Thread: https://ampcode.com/threads/T-019bdee0-e4f4-724b-8b64-fde86485d24a
- Added updateRecipient server action in actions.ts with email validation and duplicate check
- Extended RecipientsTable to support edit mode with editingRecipient state
- Edit button opens modal pre-filled with current recipient name and email
- Modal title and submit button text change based on add vs edit mode
- Table updates without page reload after successful edit
- **Learnings for future iterations:**
  - Reuse existing modal for add/edit by tracking editingRecipient state (null = add, object = edit)
  - When checking for duplicate emails on update, exclude the current record by comparing IDs

---

## 2026-01-20 - US-014
Thread: https://ampcode.com/threads/T-019bdee2-80b0-70c8-b059-c66e932d6dac
- Added deleteRecipient server action in actions.ts
- Extended RecipientsTable with delete confirmation dialog
- Delete button opens modal with "Delete [name]? This cannot be undone." message
- Confirming deletion removes recipient from database and updates table without reload
- Added CSS styles for delete button (.modal-button.delete) and confirmation text
- **Learnings for future iterations:**
  - Reuse modal-overlay pattern for confirmation dialogs, just render different content
  - Track deletingRecipient state separately from editingRecipient to avoid conflicts

---

## 2026-01-21 - US-015
Thread: https://ampcode.com/threads/T-019bdee4-19d0-771e-869c-9b48ecece2f6
- Added toggleRecipientActive server action in actions.ts
- Replaced static status badge with interactive toggle switch button
- Toggle switch has visual track/thumb animation with green (active) and gray (inactive) states
- Clicking toggle immediately updates database and local state without page reload
- Added togglingId state to show loading/disabled state during toggle operation
- Added CSS styles for toggle switch (.status-toggle, .toggle-track, .toggle-thumb, .toggle-label)
- **Learnings for future iterations:**
  - Toggle switches provide better UX than simple clickable badges for boolean states
  - Track the ID of the item being toggled (togglingId) to disable only that specific toggle

---

## 2026-01-21 - US-016
Thread: https://ampcode.com/threads/T-019bdee5-a169-779c-8fac-55e49a31683f
- Created Python export script foundation in `export/printsmith_export.py`
- Script connects to PrintSmith PostgreSQL using environment variables
- Added error handling for connection failures and missing config
- Logs progress to console with timestamps
- Created `export/requirements.txt` with psycopg2-binary and requests
- **Learnings for future iterations:**
  - Python scripts go in `export/` directory at project root
  - Use `python3 -m py_compile <file>` to verify Python syntax without running

---

## 2026-01-21 - US-017
Thread: https://ampcode.com/threads/T-019bdee6-7d7f-7182-bd55-aabf47012d0e
- Added `get_target_date()` function to calculate target date with weekend handling
- Added `get_completed_invoices()` function with SQL query joining invoice and invoicebase
- Query filters: pickupdate = target date, onpendinglist = false, isdeleted = false, voided = false
- Returns invoices list with all required fields plus total_revenue and invoice_count
- Weekend logic: Saturday ‚Üí Friday, Sunday ‚Üí Friday
- **Learnings for future iterations:**
  - Use Decimal for money aggregations to avoid float precision issues
  - Use context manager `with conn.cursor() as cur:` for auto-cleanup
  - Python weekday(): 0=Monday, 5=Saturday, 6=Sunday

---

## 2026-01-21 - US-018
Thread: https://ampcode.com/threads/T-019bdee7-e3f8-7702-baea-b6701bc729b1
- Added `get_estimates_created()` function to export yesterday's estimates
- Query joins `estimate` and `invoicebase` tables on id
- Filters by `ordereddate`, `isdeleted = false`, `voided = false`
- Returns `estimate_count` and `top_estimates` (top 10 by amount)
- Returns invoicenumber, account_name, takenby, adjustedamountdue for each estimate
- Updated `main()` to call and log the new estimate export
- **Learnings for future iterations:**
  - Follow same query pattern as invoices: JOIN on id, filter deleted/voided
  - Estimates use `ordereddate` (not `pickupdate` like invoices)
  - Return top N items for "highlights" sections to avoid email bloat

---

## 2026-01-21 - US-019
Thread: https://ampcode.com/threads/T-019bdee8-f89c-70b6-bff8-f2546da72c59
- Added `get_pm_open_invoices()` function to export pending invoices grouped by PM
- Query joins `invoice` and `invoicebase` tables, filters by `onpendinglist = true`
- Filters to valid PMs: Jim, Steve, Shelley, Ellie, Ellie Lemire
- Returns pm_name, open_count, open_total_dollars sorted by total descending
- Updated `main()` to call and log the new PM open invoices export
- **Learnings for future iterations:**
  - Use tuple for SQL IN clause with psycopg2: `WHERE field IN %s` with `(tuple_value,)`
  - Use COALESCE for SUM to handle NULL values when no records exist

---

## 2026-01-21 - US-020
Thread: https://ampcode.com/threads/T-019bdeea-3371-74e2-bf81-4815cdb3321f
- Added `get_bd_open_invoices()` function to export pending invoices grouped by BD
- Query joins `invoice` and `invoicebase` tables, filters by `onpendinglist = true`
- Filters to valid BDs: House, Paige Chamberlain, Sean Swaim, Mike Meyer, Dave Tanner, Rob Grayson, Robert Galle
- Returns bd_name, open_count, open_total_dollars sorted by total descending
- Updated `main()` to call and log the new BD open invoices export
- **Learnings for future iterations:**
  - Follow exact same pattern as get_pm_open_invoices but use `salesrep` field instead of `takenby`

---

## 2026-01-21 - US-021
Thread: https://ampcode.com/threads/T-019bdeeb-598d-7592-8d23-1c93e8279679
- Added `get_mtd_metrics()` function for month-to-date sales metrics
- Queries completed invoices from first of month to today for revenue and sales_count
- Queries estimates created this month for estimates_created count
- Queries new customers (accounts with first-ever invoice this month) using NOT EXISTS subquery
- Returns { revenue, sales_count, estimates_created, new_customers }
- Updated main() to call and log MTD metrics
- **Learnings for future iterations:**
  - Use NOT EXISTS subquery to find accounts with no prior completed invoices (new customers)
  - Use `today.replace(day=1)` to get first day of current month in Python

---

## 2026-01-21 - US-035
Thread: https://ampcode.com/threads/T-019bdeec-d760-74d2-8d6a-3f977fce14cd
- Created `src/lib/ai-content.ts` with `generateAIContent()` function
- Installed OpenAI SDK and uses gpt-4o-mini model
- Randomly selects between quote and joke content types
- Prompts specify sales/business/printing theme, 1-2 sentences, workplace appropriate
- Returns `{ type: string, content: string, attribution?: string }`
- Includes 8 fallback content items if API fails or key is missing
- **Learnings for future iterations:**
  - OpenAI SDK is already available via `npm install openai`
  - Use gpt-4o-mini for cost-effective content generation
  - Avoid ES2018+ regex flags (like `s`) for TypeScript target compatibility

---

## 2026-01-21 - US-022
Thread: https://ampcode.com/threads/T-019bdeee-5760-762b-92c7-5882230adb79
- Added `get_ytd_metrics()` function to export year-to-date sales metrics
- Query pattern follows MTD metrics but uses `first_of_year` (Jan 1) instead of `first_of_month`
- Returns revenue, sales_count, estimates_created, new_customers for annual goal progress
- Updated `main()` to call and log the new YTD metrics export
- Python script compiles without syntax errors
- **Learnings for future iterations:**
  - Use `today.replace(month=1, day=1)` to get first day of current year in Python
  - YTD/MTD metrics follow same query structure, just different date ranges

---

## 2026-01-21 - US-036
Thread: https://ampcode.com/threads/T-019bdef0-4ffb-702b-b706-07dc39fc4cbb
- Created `src/lib/daily-digest.ts` with `generateDailyDigest(recipientName: string)` function
- Fetches latest DigestData from database and Goal data for progress calculations
- Generates AI content (quote or joke) using existing `generateAIContent()` function
- Complete HTML email template with:
  - Header with Retriever logo and date
  - Personalized greeting with recipient name
  - Yesterday's numbers grid (revenue, orders, estimates, new customers)
  - Highlights section (conditional)
  - PM and BD performance tables (conditional)
  - Monthly and Annual progress bars with color coding
  - AI quote/joke at bottom with styled callout
- Helper functions: formatCurrency(), formatNumber(), formatDate(), calculateProgress(), renderProgressBar()
- Progress bars show color-coded fill based on percentage (green > lime > yellow > orange > red)
- **Learnings for future iterations:**
  - Use Intl.NumberFormat for currency/number formatting
  - Inline styles required for email HTML (no external CSS)
  - Grid layouts work in most email clients with fallback behavior
  - Export types for DigestMetrics, DigestDataPayload for reuse in other modules
---

## 2026-01-21 - US-037
Thread: https://ampcode.com/threads/T-019bdef2-6c89-7506-8109-6c78c033947a
- Installed Resend SDK via npm
- Created `src/lib/email.ts` with `sendEmail()` utility function
- Function accepts: to (string or array), subject, html
- Returns success/failure status with optional messageId or error message
- Validates RESEND_API_KEY and EMAIL_FROM env vars before sending
- Environment variables were already in .env.example from US-001
- **Learnings for future iterations:**
  - Resend SDK uses `{ data, error }` pattern - check error first
  - Handle both missing env vars and API errors separately
---

## 2026-01-21 - US-038
Thread: https://ampcode.com/threads/T-019bdef3-4b03-71e1-9dfd-0b005350e4bb
- Created `sendDailyDigest()` function in `src/lib/daily-digest.ts`
- Fetches all active recipients from database
- Generates personalized HTML for each recipient using existing `generateDailyDigest()`
- Sends email with subject "üêï Retriever Daily Digest - [Date]" via Resend
- Logs success/failure for each recipient with console.log/console.error
- Returns `SendDigestResult` with sent, failed, and errors array
- **Learnings for future iterations:**
  - Reuse existing functions (generateDailyDigest, sendEmail) for composition
  - Format date string for email subject using toLocaleDateString with short format
---

## 2026-01-21 - US-039
Thread: https://ampcode.com/threads/T-019bdef4-34f1-725e-888e-7ad06bcc119c
- Created POST `/api/digest/daily` endpoint in src/app/api/digest/daily/route.ts
- Validates `X-Cron-Secret` header against `CRON_SECRET` env var
- Returns 401 if secret header missing/invalid
- Returns 400 if no digest data available (uses getLatestDigestData check)
- Returns JSON with success, sent, and failed counts on success
- Added `/api/digest` to middleware PUBLIC_PATHS for cron access (has its own auth)
- **Learnings for future iterations:**
  - API routes with custom auth (like cron secrets) must be added to PUBLIC_PATHS in middleware
  - Use startsWith matching in PUBLIC_PATHS to cover all sub-routes under a prefix
---

## 2026-01-21 - US-040
Thread: https://ampcode.com/threads/T-019bdef5-58a3-77b3-b584-0b6c2da907e3
- Created Testing page with "Preview Daily Digest" button
- Added preview-container with iframe to render digest HTML
- Created `/api/preview/daily` endpoint that returns HTML with Content-Type: text/html
- Added `generateDailyDigestWithMockFallback()` function that uses mock data when no DigestData exists
- Warning banner displays when using mock data (via X-Mock-Data response header)
- Loading state shown during fetch
- Added CSS styles for testing page: preview-button, preview-container, preview-iframe, warning-banner
- **Learnings for future iterations:**
  - Use `srcDoc` prop on iframe to render HTML string directly instead of `src` URL
  - Use custom response headers (X-Mock-Data) to communicate metadata from API to client
  - Preview API endpoints can return HTML directly with NextResponse(html, { headers: { 'Content-Type': 'text/html' } })
---

## 2026-01-21 - US-041
Thread: https://ampcode.com/threads/T-019bdef7-ba37-746f-aae7-c98027530ab4
- Verified `/api/preview/daily` endpoint already exists from US-040
- Endpoint returns HTML with Content-Type: text/html, uses "Preview User" as recipient name
- Protected by session auth via middleware (not in PUBLIC_PATHS)
- All acceptance criteria already met
- **Learnings for future iterations:**
  - Preview endpoints are protected by middleware by default (not in PUBLIC_PATHS)

---

## 2026-01-21 - US-042
Thread: https://ampcode.com/threads/T-019bdef7-ba37-746f-aae7-c98027530ab4
- Added test email form to Testing page with email input and "Send Test" button
- Created POST `/api/test-email` endpoint to send test digests
- Client-side and server-side email validation
- Shows success/error messages after send attempt
- Added CSS styles for test email form (.test-email-form, .test-email-input, .success-message)
- **Learnings for future iterations:**
  - Reuse generateDailyDigestWithMockFallback for both preview and test email
  - Add "(TEST)" suffix to test email subjects to distinguish from real digests
---

## 2026-01-21 - US-043
Thread: https://ampcode.com/threads/T-019bdef9-b31f-7271-9627-3f2abb1a3bb2
- Created `src/lib/weekly-digest.ts` with `getWeeklyDigestData()` function
- Calculates week boundaries (Mon 00:00 to Fri 23:59) using getWeekBoundaries helper
- Fetches DigestData records for this week and last week in parallel
- Aggregates all 4 metrics: revenue, salesCount, estimatesCreated, newCustomers
- Calculates week-over-week percentage changes for each metric
- Aggregates PM and BD weekly performance summaries from daily data
- Extracts top highlights from the week (up to 10)
- Uses latest daily record for MTD/YTD data
- **Learnings for future iterations:**
  - Use `as unknown as Type` for Prisma JSON fields to satisfy TypeScript
  - Week boundaries: getDay() returns 0 for Sunday, so adjust accordingly
  - Aggregate performance data using Map for O(n) efficiency
---

## 2026-01-21 - US-044
Thread: https://ampcode.com/threads/T-019bdefb-24f1-763e-b5ea-64d2793696ae
- Created weekly digest HTML template with celebratory purple theme
- Added `generateWeeklyDigestHTML()` function in weekly-digest.ts
- Header section: "Retriever Weekly Digest" with week date range and Retriever logo
- "This Week's Wins" section: total revenue, orders, estimates, new customers in 2x2 grid + top highlights
- "Week over Week" section: comparison table with up/down arrows and percentage changes
- PM Weekly Stats section: orders completed and revenue by PM
- BD Weekly Stats section: orders completed and revenue by BD
- Monthly Progress section with color-coded progress bars
- Annual Progress section with color-coded progress bars
- AI quote/joke at bottom with styled callout
- Celebratory tone: "What a week!", "Crushing it!" in greeting
- Helper functions: formatCurrency, formatNumber, formatWeekRange, renderChangeIndicator, renderProgressBar, renderAIContent
- **Learnings for future iterations:**
  - Weekly template uses purple gradient (#7c3aed to #a855f7) to differentiate from daily (blue)
  - Use Date.toLocaleDateString with options for week range formatting
  - Export PerformanceData type for use in other modules
---
